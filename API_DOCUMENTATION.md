# Live2D Control API Documentation

This document outlines the REST API endpoints used for controlling the Live2D avatar from an AI Agent.

**Base URL:** `http://localhost:8000`

---

## Endpoints

### 1. `GET /api/status`
Returns the current system status, including whether the frontend is connected and idle.

**Response:**
**Response:**
```json
{
  "clients": {
    "uuid-1234": {
      "queue_length": 0,
      "model_state": {
        "current_profile": "happy",
        "current_scene": "intro_scene",
        "queue_size": 2,
        "is_looping": false,
        "last_report_ts": 1678888888,
        "is_muted": false,
        "is_sync_enabled": true
      },
      "last_seen_seconds_ago": 0
    }
  },
  "active_session_count": 1
}
```

### `POST /api/status`
Updates the system status. Supports setting the mute and sync states.

**Request Body (all fields optional):**
**Request Body (`client_id` optional, others optional):**
```json
{ 
  "client_id": "uuid-1234",
  "is_muted": true, 
  "is_sync_enabled": false 
}
```
*Note: If `client_id` is omitted, the setting is broadcast to ALL active clients.*

**Response:**
```json
{
    "status": "updated",
    "targets": 1
}
```

---

### 2. Apply Profile
**Endpoint:** `POST /api/applyProfile`
**Description:** Applies a profile to the avatar.

**Request Body:**
| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `profile` | `string` | **Yes** | The profile name to apply. |
| `client_id` | `string` | No | Target specific client. If omitted, broadcasts to all. |

**Example (Targeted):**
```bash
curl -X POST http://localhost:8000/api/applyProfile \
  -H "Content-Type: application/json" \
  -d '{
    "profile": "happy",
    "client_id": "uuid-1234"
  }'
```

**Example (Broadcast):**
```bash
curl -X POST http://localhost:8000/api/applyProfile \
  -H "Content-Type: application/json" \
  -d '{
    "profile": "happy"
  }'
```

### 3. Play Scene
**Endpoint:** `POST /api/playScene`
**Description:** Plays a defined scene with optional audio and looping.

**Request Body:**
| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `scene` | `string` | **Yes** | The scene name to play. |
| `loop` | `boolean` | No | If `true`, the scene loops indefinitely. Default `false`. |
| `audio_url` | `string` | No | URL of audio to play with the scene. |
| `msg` | `string` | No | Subtitle text to display. |
| `interrupt` | `boolean` | No | If `true`, stops current action immediately. Default `true`. |
| `client_id` | `string` | No | Target specific client. If omitted, broadcasts to all. |

**Example (Basic):**
```bash
curl -X POST http://localhost:8000/api/playScene \
  -H "Content-Type: application/json" \
  -d '{
    "scene": "intro"
  }'
```

**Example (Full Options):**
```bash
curl -X POST http://localhost:8000/api/playScene \
  -H "Content-Type: application/json" \
  -d '{
    "scene": "scene1",
    "loop": true,
    "audio_url": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
    "msg": "Singing...",
    "interrupt": true
  }'
```

---

### 4. `GET /api/queue?client_id=<uuid>`
Used by the frontend to poll for the next command for a specific session.
*   **Query Parameter:** `client_id` (Required) - Unique ID generated by Frontend.

**Response (No Command):** `null`

**Response (Command Available - Profile):**
```json
{
  "payload": { "profile": "happy" },
  "interrupt": false
}
```

**Response (Command Available - Scene):**
```json
{
  "payload": { 
      "scene": "intro_scene",
      "loop": false,
      "audio_url": null,
      "msg": null
  },
  "interrupt": true
}
```

---

### 5. `POST /api/report`
Used by the frontend to report its internal state. Requires `client_id` in the body.

**Request Body:**
```json
{
    "client_id": "uuid-1234",
    "current_profile": "happy",
    "current_scene": null,
    "queue_size": 2,
    "is_looping": false
}
```

**Response:**
```json
{ "status": "ok" }
```

---

### 6. `GET /api/proxy?url=<url>`
Proxies remote audio files to bypass browser CORS restrictions. Used internally by the frontend.

**Response:** Binary audio data (audio/mpeg, audio/wav, etc.)

---

## Profile Customization
You can define or modify poses in `frontend/profiles.json` (path configured via `settings.json`). Each profile has a name, optional scopes, and a set of Live2D parameters.

```json
"angry": {
    "scopes": ["face", "eyes"],
    "parameters": {
        "Param36": -30,
        "ParamBrowLForm": 0.5
    }
}
```
*Note: You can find valid Parameter IDs in the Live2D viewer's **Settings** panel.*

---

### 7. `GET /api/profiles`
Returns all profiles from `profiles.json`.

**Response:**
```json
{
  "angry": {
    "scopes": ["face", "eyes"],
    "parameters": { "Param36": -30 }
  },
  "happy": {
    "scopes": ["face"],
    "parameters": { "ParamMouthForm": 1 }
  }
}
```

**Example:**
```bash
curl http://localhost:8000/api/profiles
```

---

### 8. `POST /api/profiles`
Save or update a profile in `profiles.json`.

**Request Body:**
| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `name` | `string` | **Yes** | Profile name. Only letters, numbers, hyphens, underscores, and Unicode characters allowed. No spaces or special characters (`"'`/\<>|:*?`). |
| `scopes` | `array` | No | List of scope strings, e.g. `["eyes", "mouth"]`. Defaults to `[]`. |
| `parameters` | `object` | No | Map of parameter IDs to values, e.g. `{"Param36": -30}`. Defaults to `{}`. |

**Example:**
```bash
curl -X POST http://localhost:8000/api/profiles \
  -H "Content-Type: application/json" \
  -d '{
    "name": "angry",
    "scopes": ["face", "eyes"],
    "parameters": {"Param36": -30}
  }'
```

**Response:**
```json
{ "status": "ok", "name": "angry" }
```

---

### 9. `DELETE /api/profiles?name=<name>`
Delete a profile from `profiles.json`.

**Query Parameters:**
| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `name` | `string` | **Yes** | Name of the profile to delete. |

**Example:**
```bash
curl -X DELETE "http://localhost:8000/api/profiles?name=angry"
```

**Response:**
```json
{ "status": "ok", "name": "angry" }
```

---

### 10. `DELETE /api/scenes?name=<name>`
Delete a scene from `scenes.json`.

**Query Parameters:**
| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `name` | `string` | **Yes** | Name of the scene to delete. |

**Example:**
```bash
curl -X DELETE "http://localhost:8000/api/scenes?name=scene1"
```

**Response:**
```json
{ "status": "ok", "name": "scene1" }
```

---

### 11. `POST /api/upload`
Upload an audio file to the server.

**Request:**
Multipart form-data with a `file` field.

**Response:**
```json
{
  "status": "uploaded",
  "filename": "audio.mp3",
  "url": "/api/uploads/audio.mp3"
}
```

**Example:**
```bash
curl -X POST http://localhost:8000/api/upload \
  -F "file=@/path/to/your/audio.mp3"
```

